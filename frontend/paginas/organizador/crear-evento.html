<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Crear Evento - Organizador</title>
	<link rel="stylesheet" href="../../estilos/global.css">
	<link rel="stylesheet" href="../../estilos/componentes.css">
</head>
<body>
	<div id="headerContainer"></div>

	<section style="padding: 60px 0;">
		<div class="contenedor-estrecho">
			<a href="./eventos.html" class="btn btn-secundario mb-lg">← Volver a Mis Eventos</a>
			
			<div class="tarjeta">
				<h1>Crear Nuevo Evento</h1>
				
				<form id="formEvento">
					<div class="form-grupo">
						<label class="form-label" for="nombre">Nombre del Evento *</label>
						<input type="text" id="nombre" class="form-input" required maxlength="200">
					</div>

					<div class="form-grupo">
						<label class="form-label" for="descripcion">Descripción</label>
						<textarea id="descripcion" class="form-input" rows="5"></textarea>
					</div>

					<div class="grid grid-2">
						<div class="form-grupo">
							<label class="form-label" for="fecha_inicio">Fecha y Hora de Inicio *</label>
							<input type="datetime-local" id="fecha_inicio" class="form-input" required>
						</div>

						<div class="form-grupo">
							<label class="form-label" for="fecha_fin">Fecha y Hora de Fin *</label>
							<input type="datetime-local" id="fecha_fin" class="form-input" required>
						</div>
					</div>

					<div class="form-grupo">
						<label class="form-label" for="ubicacion">Ubicación *</label>
						<input type="text" id="ubicacion" class="form-input" required maxlength="300" placeholder="Ej: Centro de Convenciones">
					</div>

					<div class="form-grupo">
						<label class="form-label" for="direccion">Dirección Completa</label>
						<textarea id="direccion" class="form-input" rows="2" placeholder="Dirección detallada del evento"></textarea>
					</div>

					<div class="form-grupo">
						<label class="form-label" for="imagen_url">URL de Imagen</label>
						<input type="url" id="imagen_url" class="form-input" placeholder="https://ejemplo.com/imagen.jpg">
						<small style="color: var(--color-gris-medio);">URL de la imagen del evento</small>
					</div>

					<div class="form-grupo">
						<label class="form-label" for="aforo_maximo">Aforo Máximo *</label>
						<input type="number" id="aforo_maximo" class="form-input" required min="1" placeholder="100">
					</div>

					<div class="form-grupo">
						<label class="form-label" for="estado">Estado</label>
						<select id="estado" class="form-input">
							<option value="borrador">Borrador (no visible al público)</option>
							<option value="activo">Activo (visible al público)</option>
						</select>
					</div>

					<div id="errorForm" class="alerta alerta-error oculto"></div>

					<div style="display: flex; gap: 12px; flex-wrap: wrap;">
						<button type="submit" class="btn btn-primario" id="btnGuardar">
							Crear Evento
						</button>
						<a href="./eventos.html" class="btn btn-secundario">
							Cancelar
						</a>
					</div>
				</form>
			</div>
		</div>
	</section>

	<div id="footerContainer"></div>

	<script src="../../scripts/config.js"></script>
	<script src="../../scripts/api-cliente.js"></script>
	<script src="../../scripts/auth.js"></script>
	<script src="../../scripts/utilidades.js"></script>
	<script src="../../scripts/header.js"></script>
	<script>
		fetch('../../componentes/header.html').then(r => r.text()).then(h => document.getElementById('headerContainer').innerHTML = h);
		fetch('../../componentes/footer.html').then(r => r.text()).then(h => document.getElementById('footerContainer').innerHTML = h);

		if (!Auth.requiereRol([CONFIG.ROLES.ORGANIZADOR, CONFIG.ROLES.ADMINISTRADOR])) {}

		document.getElementById('formEvento').addEventListener('submit', async (e) => {
			e.preventDefault();

			const datos = {
				nombre: document.getElementById('nombre').value.trim(),
				descripcion: document.getElementById('descripcion').value.trim(),
				fecha_inicio: document.getElementById('fecha_inicio').value,
				fecha_fin: document.getElementById('fecha_fin').value,
				ubicacion: document.getElementById('ubicacion').value.trim(),
				direccion: document.getElementById('direccion').value.trim() || null,
				imagen_url: document.getElementById('imagen_url').value.trim() || null,
				aforo_maximo: parseInt(document.getElementById('aforo_maximo').value),
				estado: document.getElementById('estado').value
			};

			const btnGuardar = document.getElementById('btnGuardar');
			const errorDiv = document.getElementById('errorForm');
			errorDiv.classList.add('oculto');

			if (new Date(datos.fecha_fin) <= new Date(datos.fecha_inicio)) {
				errorDiv.textContent = 'La fecha de fin debe ser posterior a la fecha de inicio';
				errorDiv.classList.remove('oculto');
				return;
			}

			try {
				btnGuardar.disabled = true;
				btnGuardar.textContent = 'Creando...';

				const response = await apiCliente.post('/eventos', datos);
				mostrarToast('Evento creado exitosamente', 'exito');
				
				setTimeout(() => {
					window.location.href = `./editar-evento.html?id=${response.datos.id}`;
				}, 1500);

			} catch (error) {
				console.error('Error al crear evento:', error);
				errorDiv.textContent = error.message || 'Error al crear evento';
				errorDiv.classList.remove('oculto');
				btnGuardar.disabled = false;
				btnGuardar.textContent = 'Crear Evento';
			}
		});
	</script>
</body>
</html>

