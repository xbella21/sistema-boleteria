<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Mi Perfil - Sistema de Gestión de Eventos</title>
	<link rel="stylesheet" href="../estilos/global.css">
	<link rel="stylesheet" href="../estilos/componentes.css">
</head>
<body>
	<div id="headerContainer"></div>

	<section style="padding: 60px 0;">
		<div class="contenedor-estrecho">
			<h1>Mi Perfil</h1>

			<!-- Información del usuario -->
			<div class="tarjeta mb-xl">
				<h2>Información Personal</h2>
				<form id="formPerfil">
					<div class="form-grupo">
						<label class="form-label" for="nombre">Nombre</label>
						<input type="text" id="nombre" class="form-input" required>
					</div>

					<div class="form-grupo">
						<label class="form-label" for="apellido">Apellido</label>
						<input type="text" id="apellido" class="form-input" required>
					</div>

					<div class="form-grupo">
						<label class="form-label" for="email">Correo Electrónico</label>
						<input type="email" id="email" class="form-input" disabled>
						<small style="color: var(--color-gris-medio);">El correo no se puede modificar</small>
					</div>

					<div class="form-grupo">
						<label class="form-label" for="telefono">Teléfono</label>
						<input type="tel" id="telefono" class="form-input">
					</div>

					<div class="form-grupo">
						<label class="form-label">Rol</label>
						<div id="rolBadge" style="display: inline-block; padding: 8px 16px; border-radius: 8px; background: var(--color-primario); color: white; font-weight: 600;"></div>
					</div>

					<div class="form-grupo">
						<label class="form-label">Miembro desde</label>
						<div id="fechaCreacion" style="color: var(--color-gris-medio);"></div>
					</div>

					<div id="errorPerfil" class="alerta alerta-error oculto"></div>
					<div id="exitoPerfil" class="alerta alerta-exito oculto"></div>

					<button type="submit" class="btn btn-primario btn-block" id="btnGuardar">
						Guardar Cambios
					</button>
				</form>
			</div>

			<!-- Cambiar contraseña -->
			<div class="tarjeta mb-xl">
				<h2>Cambiar Contraseña</h2>
				<form id="formPassword">
					<div class="form-grupo">
						<label class="form-label" for="passwordActual">Contraseña Actual</label>
						<input type="password" id="passwordActual" class="form-input" required>
					</div>

					<div class="form-grupo">
						<label class="form-label" for="passwordNuevo">Nueva Contraseña</label>
						<input type="password" id="passwordNuevo" class="form-input" required minlength="6">
						<small style="color: var(--color-gris-medio);">Mínimo 6 caracteres</small>
					</div>

					<div class="form-grupo">
						<label class="form-label" for="passwordConfirmar">Confirmar Nueva Contraseña</label>
						<input type="password" id="passwordConfirmar" class="form-input" required minlength="6">
					</div>

					<div id="errorPassword" class="alerta alerta-error oculto"></div>
					<div id="exitoPassword" class="alerta alerta-exito oculto"></div>

					<button type="submit" class="btn btn-primario btn-block" id="btnCambiarPassword">
						Cambiar Contraseña
					</button>
				</form>
			</div>

			<!-- Estadísticas del usuario -->
			<div class="tarjeta">
				<h2>Mis Estadísticas</h2>
				<div class="grid grid-3">
					<div class="text-center">
						<div style="font-size: 48px; color: var(--color-primario); font-weight: 700;" id="totalBoletos">0</div>
						<div style="color: var(--color-gris-medio);">Boletos Comprados</div>
					</div>
					<div class="text-center">
						<div style="font-size: 48px; color: var(--color-secundario); font-weight: 700;" id="boletosValidos">0</div>
						<div style="color: var(--color-gris-medio);">Boletos Válidos</div>
					</div>
					<div class="text-center">
						<div style="font-size: 48px; color: var(--color-gris-medio); font-weight: 700;" id="boletosUsados">0</div>
						<div style="color: var(--color-gris-medio);">Boletos Usados</div>
					</div>
				</div>
			</div>
		</div>
	</section>

	<div id="footerContainer"></div>

	<script src="../scripts/config.js"></script>
	<script src="../scripts/api-cliente.js"></script>
	<script src="../scripts/auth.js"></script>
	<script src="../scripts/utilidades.js"></script>
	<script src="../scripts/header.js"></script>
	<script>
		// Cargar componentes
		fetch('../componentes/header.html').then(r => r.text()).then(h => document.getElementById('headerContainer').innerHTML = h);
		fetch('../componentes/footer.html').then(r => r.text()).then(h => document.getElementById('footerContainer').innerHTML = h);

		// Verificar autenticación
		if (!Auth.requiereAutenticacion()) {
			// Ya redirige automáticamente
		}

		// Cargar información del usuario
		async function cargarPerfil() {
			try {
				const response = await apiCliente.get('/auth/me');
				const usuario = response.datos;

				// Llenar formulario
				document.getElementById('nombre').value = usuario.nombre;
				document.getElementById('apellido').value = usuario.apellido;
				document.getElementById('email').value = usuario.email;
				document.getElementById('telefono').value = usuario.telefono || '';
				
				// Mostrar rol
				const rolColors = {
					administrador: 'background: var(--color-error);',
					organizador: 'background: var(--color-primario);',
					taquilla: 'background: var(--color-advertencia);',
					asistente: 'background: var(--color-secundario);'
				};
				const rolBadge = document.getElementById('rolBadge');
				rolBadge.textContent = usuario.rol.toUpperCase();
				rolBadge.style.cssText = rolColors[usuario.rol] + ' color: white; padding: 8px 16px; border-radius: 8px; font-weight: 600;';

				// Fecha de creación
				document.getElementById('fechaCreacion').textContent = formatearFecha(usuario.fecha_creacion, false);

			} catch (error) {
				console.error('Error al cargar perfil:', error);
				mostrarToast('Error al cargar información del perfil', 'error');
			}
		}

		// Cargar estadísticas
		async function cargarEstadisticas() {
			try {
				const response = await apiCliente.get('/boletos/mis-boletos');
				const boletos = response.datos || [];

				document.getElementById('totalBoletos').textContent = boletos.length;
				document.getElementById('boletosValidos').textContent = boletos.filter(b => b.estado === 'valido').length;
				document.getElementById('boletosUsados').textContent = boletos.filter(b => b.estado === 'usado').length;

			} catch (error) {
				console.error('Error al cargar estadísticas:', error);
			}
		}

		// Guardar perfil
		document.getElementById('formPerfil').addEventListener('submit', async (e) => {
			e.preventDefault();

			const nombre = document.getElementById('nombre').value.trim();
			const apellido = document.getElementById('apellido').value.trim();
			const telefono = document.getElementById('telefono').value.trim();
			const btnGuardar = document.getElementById('btnGuardar');
			const errorDiv = document.getElementById('errorPerfil');
			const exitoDiv = document.getElementById('exitoPerfil');

			errorDiv.classList.add('oculto');
			exitoDiv.classList.add('oculto');

			if (!nombre || !apellido) {
				errorDiv.textContent = 'Nombre y apellido son requeridos';
				errorDiv.classList.remove('oculto');
				return;
			}

			try {
				btnGuardar.disabled = true;
				btnGuardar.textContent = 'Guardando...';

				await apiCliente.put('/auth/perfil', {
					nombre,
					apellido,
					telefono: telefono || null
				});

				// Actualizar información en localStorage
				const usuario = Auth.obtenerUsuario();
				usuario.nombre = nombre;
				usuario.apellido = apellido;
				usuario.telefono = telefono;
				Auth.actualizarUsuario(usuario);

				exitoDiv.textContent = 'Perfil actualizado exitosamente';
				exitoDiv.classList.remove('oculto');
				mostrarToast('Perfil actualizado exitosamente', 'exito');

				// Recargar header para mostrar nombre actualizado
				setTimeout(() => {
					window.location.reload();
				}, 1500);

			} catch (error) {
				console.error('Error al guardar perfil:', error);
				errorDiv.textContent = error.message || 'Error al guardar cambios';
				errorDiv.classList.remove('oculto');
			} finally {
				btnGuardar.disabled = false;
				btnGuardar.textContent = 'Guardar Cambios';
			}
		});

		// Cambiar contraseña
		document.getElementById('formPassword').addEventListener('submit', async (e) => {
			e.preventDefault();

			const passwordActual = document.getElementById('passwordActual').value;
			const passwordNuevo = document.getElementById('passwordNuevo').value;
			const passwordConfirmar = document.getElementById('passwordConfirmar').value;
			const btnCambiar = document.getElementById('btnCambiarPassword');
			const errorDiv = document.getElementById('errorPassword');
			const exitoDiv = document.getElementById('exitoPassword');

			errorDiv.classList.add('oculto');
			exitoDiv.classList.add('oculto');

			// Validar contraseñas
			if (passwordNuevo.length < 6) {
				errorDiv.textContent = 'La nueva contraseña debe tener al menos 6 caracteres';
				errorDiv.classList.remove('oculto');
				return;
			}

			if (passwordNuevo !== passwordConfirmar) {
				errorDiv.textContent = 'Las contraseñas no coinciden';
				errorDiv.classList.remove('oculto');
				return;
			}

			try {
				btnCambiar.disabled = true;
				btnCambiar.textContent = 'Cambiando...';

				await apiCliente.post('/auth/cambiar-password', {
					passwordActual,
					passwordNuevo
				});

				// Limpiar formulario
				document.getElementById('formPassword').reset();

				exitoDiv.textContent = 'Contraseña cambiada exitosamente';
				exitoDiv.classList.remove('oculto');
				mostrarToast('Contraseña cambiada exitosamente', 'exito');

			} catch (error) {
				console.error('Error al cambiar contraseña:', error);
				errorDiv.textContent = error.message || 'Error al cambiar contraseña';
				errorDiv.classList.remove('oculto');
			} finally {
				btnCambiar.disabled = false;
				btnCambiar.textContent = 'Cambiar Contraseña';
			}
		});

		// Inicializar
		document.addEventListener('DOMContentLoaded', () => {
			cargarPerfil();
			cargarEstadisticas();
		});
	</script>
</body>
</html>

